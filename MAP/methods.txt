Behavior and video tracking

Mice performed an auditory delayed response task 21 (Figure 1A). The instruction stimuli during the sample epoch were pure tones played at one of two frequencies (3 kHz or 12 kHz). Each tone was played three times for 150 ms with 100 ms inter-tone intervals. The sample epoch was followed by a 1.2 s delay epoch. An auditory ‘Go’ cue (carrier frequency of 6 kHz with 360 Hz modulating fre-
quency, 0.1 s duration) indicated the end of the delay epoch. Licking early during the sample/delay epoch triggered a replay of the epoch. During the response epoch (answer period: 1.5 s) mice reported the instruction by licking one of the two lick ports. Licking (consumption period: 1.5 s) the correct lick port triggered a small water reward (0.1 ~ 0.2 ul). Licking the incorrect lick port triggered a timeout (1-3 s). After mice stopped licking for 1.5 s, the trial ended, followed by a 250 ms inter-trial-interval. Early lick trials and no
response trials were excluded for analysis. Overall performance was computed as the fraction of correct control trials (i.e. no photostimulation), excluding any early lick trials. We selected experimental sessions for analysis based on following criteria: overall behavioral performance (> 65%), and at least 50 correct lick left and lick right trials each. Mice performed on average 476 (Mean; range, 130-785) trials per session with 84% correct rate (range, 65-99%; STAR Methods). During the delay epoch, mice maintain a memory of their choice and plan a movement.

Two CMOS cameras (CM3-U3-13Y3M, FLIR) were used to track orofacial movements of the mouse under IR light illumination (940 nm LED). The cameras were equipped with 4-12 mm focal length lenses (12VM412ASIR, Tamron) and a pixel resolution of 71 mm. High-speed videos from a side view and a bottom view (Figure 1C) were acquired at 300 Hz using software FlyCapture (TELEDYNE FLIR). We trained DeepLabCut 39 to track the movement of tongue, jaw and nose (Figure 1I).

Multi-regional electrophysiological recordings

We designed a ﬂexible manipulator system for multiple Neuropixels probe insertions (https://www.janelia.org/open-science/manipulator-system-for-multiple-neuropixels-probe-recordings). Three to four small craniotomies (diameter, 1  1.5 mm) were made over target brain areas one day before the ﬁrst recording session. Details of recordings made with multiple Neuropixels probes in head-restrained behaving animals have been published (dx.doi.org/10.17504/protocols.io.8tphwmn). Target regions, insertions angles, probe types, etc. are summarized in Table S2. All coordinates are given with respect to Bregma (AP, anterior-posterior; ML, medial-lateral; DV, dorsal-ventral).

Extracellular spikes were recorded using Neuropixels 1.0 probes, 2.0 single-shank (SS) and 2.0 multi-shank (MS) probes 3,4 (Table S2). Three to seven recordings were made from each craniotomy. Recording depth was inferred from manipulator readings (Sensapax uMp manipulators). After completion of probe insertion, brain tissue was allowed to settle for several minutes before recording. During recordings the craniotomies were immersed in saline.

Probes were conﬁgured and data were visualized and streamed to disk using the open-source software package SpikeGLX (https://billkarsh.github.io/SpikeGLX/). Data from up to ﬁve simultaneously recorded probes were acquired at 30 kHz. Sync waves (0.5 s duty cycle TTL pulses) were recorded across probes and on auxiliary channels for synchronization.

Photoinhibition

Light from two 473 nm lasers (Coherent OBIS LS/LX) was used to illuminate the two hemispheres of ALM. The laser power was controlled by analog outputs controlled by a Bpod (Sanworks). Photoinactivation of ALM (centered on AP 2.5 mm; ML 1.5 mm) was performed through clear-skull cap implant11 or via craniotomy by directing the laser over the skull (beam diameter, 1.8 mm at 4 sigma). Photoinhibition of the left-, right-ALM hemisphere, or both hemispheres was deployed on a subset of ~25% randomly interleaved trials 11,21 (N = 17 VGAT-ChR2-EYFP mice). To prevent the mice from distinguishing photostimulation trials from control rials using visual cues, a ‘masking ﬂash’ (1 ms pulses at 10 Hz) was delivered using 470 nm LEDs in front of the mice throughout the entire trial. For silencing ALM, we stimulated cortical GABAergic neurons in VGAT-ChR2-EYFP mice. We used 40 Hz photostimulation with a sinusoidal temporal proﬁle (5 mW average power per hemisphere) and a 100 ms linear ramping down during the laser offset to reduce rebound neuronal activity. This photo stimulus is expected to silence glutamatergic neurons in all of ALM. 37 We silenced ALM activity during the late delay epoch (last 0.5 s), including the 100 ms ramp-down. Thus, photoinhibition always ended before the ‘Go’ cue.

To analyze the effects of photoinhibition, units with at least 10 photostimulation trials were selected for analysis (Figures 5 and S5). Bilateral ALM photostimulation reduced behavior performance from 83.2% to 71.7% (N = 17 VGAT-ChR2-EYFP mice, n = 93 sessions). To exclude the effects of rebound population activity in the thalamus 16 and other subcortical regions, we used a 20-120 ms
time window after photo stimulation onset to measure the effect of ALM inactivation in downstream regions (Figures 5 and S5). For ALM itself, we used 500 ms (i.e. the entire inactivation period) to calculate spike rate reduction.

Spike sorting and quality control

We developed a data pipeline for preprocessing, spike sorting and quality control (https://github.com/jenniferColonell/ecephys_spike_sorting). The extracellular recording traces were ﬁrst band-pass ﬁltered (Butterworth acausal ﬁlter, 250 Hz - 9 kHz). We then sorted the dataset using both Kilosort2 32 (MATLAB version, GitHub - jenniferColonell/KS20_for_preprocessed_data: Release version of KS2 for preprocessed data) and Kilosort2.5 4 (Python version, GitHub - jenniferColonell/pykilosort: [WIP] Python port of Kilosort 2). Both sorting methods gave similar results. In the analyses presented in the paper, we used the output from Kilosort2. Each output cluster was associated with a list of 15 quality metrics calculated to assess isolation and sorting quality 7 (i.e. quality control) (https://github.com/AllenInstitute/ecephys_spike_sorting/tree/master/ecephys_spike_sorting/modules/quality_metrics).

The details of the spike sorting and quality control are described in an accompanying white paper (https://doi.org/10.25378/janelia.24066108.v1). In brief, we used 15 cluster quality metrics to train classiﬁers - one for each of the major ﬁve brain areas (cortex, striatum, thalamus, midbrain and medulla). The classiﬁers were trained based on labels derived from manual curation. We curated Kilosort2 output (28 penetrations from ﬁve brain areas) using the open-source graphical user interface Phy (GitHub - cortex-lab/phy: phy: interactive visualization and manual spike sorting of large-scale ephys data). Each cluster was labeled as a ‘good’ or ‘unlabeled’ unit. Annotators were blind to location, recording condition and trial type information. Based on the annotated labels of all clusters and associated quality metrics, we trained ﬁve region-speciﬁc classiﬁers using logistic regression. Applying the trained classiﬁers to the rest of the dataset provided lists of units that were labeled as ‘good’ and were used for the analysis in this paper. We applied the cortex classiﬁer to ALM and other cortex, hippocampus, olfactory and cortical subplate units; the striatum classiﬁer to striatum and pallidum units; the thalamus classiﬁer to thalamus and hypothalamus units; the midbrain classiﬁer to midbrain and pons units; the medulla classiﬁer to medulla and cerebellum units. We calculated the rate at which the classiﬁer incorrectly labeled ’unlabeled’ units as ’good’, using 10-fold cross-validation on held-out manually labeled units (false alarm rate): 7.8%; striatum: 6.4%; thalamus: 7.3%; midbrain: 5.5%; medulla 4.3%. This method yielded 8717 good units from ALM, 7664 from striatum, 12808 from thalamus, 7495 from midbrain and 2928 from medulla, etc. Overall, the dataset consisted of 69,943 good units recorded across 173 behavioral sessions, from which 655 probe insertions were made. This corresponds to 25.9 % of clusters reported by Kilosort2. 
